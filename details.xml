<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE vxml PUBLIC "-//W3C//DTD VOICEXML 2.1//EN" "http://www.w3.org/TR/2007/REC-voicexml21-20070619/vxml.dtd">

<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml" xmlns:voxeo="http://community.voxeo.com/xmlns/vxml" application="root.xml">
    <meta name="maintainer" content="burrelal@gmail.com" />

    <script><![CDATA[
        var searchUrl = "https://maps.googleapis.com/maps/api/place/textsearch/xml?query={query}&key=AIzaSyCVqHbaIe-Dtnt7WUHGOHUAUuV1_OWFoag",
            placeUrl = "https://maps.googleapis.com/maps/api/place/details/xml?placeid={id}&key=AIzaSyCVqHbaIe-Dtnt7WUHGOHUAUuV1_OWFoag"

        function assembleSearchUrl(location, business) {
            location = location.replace(" ", "+");
            business = business.replace(" ", "+");
            return searchUrl.replace("{query}", location+"+"+business);
        }

        function assemblePlaceUrl(place_id) {
            return placeUrl.replace("{id}", place_id);
        }

        function getPlaceId(results) {
            var establishment = results.getElementsByTagName("result").item(0),
                id = establishment.getElementsByTagName("place_id").item(0).firstChild.data;

            return id;
        }

        function parseResults(results) {
            var establishment = results.getElementsByTagName("result").item(0),
                address = establishment.getElementsByTagName("formatted_address").item(0).firstChild.data,
                phone = establishment.getElementsByTagName("formatted_phone_number").item(0).firstChild.data;

            address = address.replace(', United States', '')

            return results = {
                'address': address,
                'phone': phone,
                'hours': false
            }
        }

        function get(obj, key) {
            return obj[key];
        }
    ]]></script>

    <form id="GetDetails">
        <block>
            <!-- <prompt>
                <value expr="application.request_type" />
                <value expr="application.business" />
                <value expr="application.location" />
            </prompt> -->

            <!-- Search using the location and business params, and get the ID -->
            <data name="SearchResults" srcexpr="assembleSearchUrl(application.location, application.business)" />
            <assign name="SearchResults" expr="SearchResults.documentElement" />
            <assign name="application.placeid" expr="getPlaceId(SearchResults)" />

            <!-- Get the place details -->
            <data name="PlaceDetails" srcexpr="assemblePlaceUrl(application.placeid)" />
            <assign name="PlaceDetails" expr="PlaceDetails.documentElement" />
            <assign name="application.result" expr="parseResults(PlaceDetails)" />

			<goto next="#ProvideResults" />
        </block>
    </form>

    <form id="ProvideResults">
    	<field>
    		<prompt>
                The <value expr="application.request_type"/> for <value expr="application.business"/>
    	    	in <value expr="application.location"/> is
                <break strength="weak" />
        		<value expr="get(application.result, application.request_type)" />
                <break strength="weak" />
        	</prompt>
    	</field>

    	<filled>
    	</filled>
    </form>

</vxml>
