<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE vxml PUBLIC "-//W3C//DTD VOICEXML 2.1//EN" "http://www.w3.org/TR/2007/REC-voicexml21-20070619/vxml.dtd">

<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml" xmlns:voxeo="http://community.voxeo.com/xmlns/vxml" application="root.xml">
    <meta name="maintainer" content="burrelal@gmail.com" />

    <script><![CDATA[
        var searchUrl = "https://maps.googleapis.com/maps/api/place/textsearch/xml?query={query}&key=AIzaSyCVqHbaIe-Dtnt7WUHGOHUAUuV1_OWFoag",

        	placeUrl = "https://maps.googleapis.com/maps/api/place/details/xml?placeid={id}&key=AIzaSyCVqHbaIe-Dtnt7WUHGOHUAUuV1_OWFoag",
            textUrl = "http://alexburrell.com/uw/dialog/project/text.php";

        function assembleSearchUrl(location, business) {
            location = location.replace(/ /g, "+");
            business = business.replace(/ /g, "+");
            return searchUrl.replace("{query}", location+"+"+business);
        }

        function assemblePlaceUrl(place_id) {
            return placeUrl.replace("{id}", place_id);
        }

        function assembleTextUrl(details) {
            details = details.replace(' ', '%20');
            return textUrl.replace("{message}", details);
        }

        function getPlaceId(results) {
            var establishment = results.getElementsByTagName("result").item(0),
                id = establishment.getElementsByTagName("place_id").item(0).firstChild.data;

            return id;
        }

        function assembleIdUrl (place_id) {
        	return idUrl.replace("{query}", place_id);
        }

        function getPlaceId (document) {
        	return document.getElementsByTagName("place_id").item(0).textContent;
        }

        function getLocalDay(offset) {
            offset = parseInt(offset);
            var today = new Date(),
                utc = today.getTime() + (today.getTimezoneOffset() * 60000),
                local_date = new Date(utc + (3600000 * offset)),
                local_day = local_date.getDay() - 1;

            if (local_day < 0) local_day = 6;

            return local_day;
        }

        function parseResults(results, timezone) {
            var today = getLocalDay(timezone);

            var establishment = results.getElementsByTagName("result").item(0),

            	address = establishment.getElementsByTagName("formatted_address").item(0).firstChild.data,
                phone = establishment.getElementsByTagName("formatted_phone_number").item(0).firstChild.data,
                hours = establishment.getElementsByTagName("weekday_text").item(today).firstChild.data;

            address = address.replace(', United States', '');
            address = address.replace('E.','East').replace('W.','West').replace('N.','North').replace('S.','South');

            return results = {
                'address': address,
                'phone': phone,
                'hours': hours
            }
        }

        function get(obj, key) {
            return obj[key];
        }
    ]]></script>

    <form id="GetDetails">
        <block>
            <!-- Search using the location and business params, and get the ID -->
            <data name="SearchResults" srcexpr="assembleSearchUrl(application.location, application.business)" />
            <assign name="SearchResults" expr="SearchResults.documentElement" />
            <assign name="application.placeid" expr="getPlaceId(SearchResults)" />

            <!-- Get the place details -->
            <data name="PlaceDetails" srcexpr="assemblePlaceUrl(application.placeid)" />
            <assign name="PlaceDetails" expr="PlaceDetails.documentElement" />
            <!-- <prompt>
                <value expr="application.timezone" />
            </prompt> -->
            <assign name="application.result" expr="parseResults(PlaceDetails, application.timezone)" />

			<goto next="#ProvideResults" />
        </block>
    </form>

    <form id="ProvideResults">
    	<block>
            <assign name="application.requestedData" expr="get(application.result, application.request_type)" />
    		<prompt>
                Here's the <value expr="application.request_type"/> for <value expr="application.business"/>
    	    	in <value expr="application.location" />
                <break />
        		<value expr="application.requestedData" />
                <break />
        	</prompt>
            <goto next="#Further" />
    	</block>
    </form>

	<!-- Provide further information about current business -->
	<form id="Further">
		<field name="Request" type="boolean">
			<prompt> Would you like other information about <value expr="application.business" />? </prompt>

            <filled>
                <if cond="!Request">
                    <goto next="#TextResults" />
    			</if>
            </filled>
		</field>

        <field name="RequestTypeField">
            <grammar src="hello_grammar.xml#RequestType" type="application/grammar-xml" maxage="1" />
            <prompt>
                Do you want hours, an address, or a phone number?
            </prompt>

            <filled>
                <assign name="application.request_type" expr="RequestTypeField$.interpretation.RequestTypeField" />
                <goto next="#ProvideResults" />
            </filled>
        </field>
	</form>


    <form id="TextResults">
        <field name="Text">
            <prompt>
            	Would you like a text message with the <value expr="application.request_type" />
            	for <value expr="application.business" /> ?
                <break />
            </prompt>
            <grammar xml:lang="en-us" root="yesno">
            	<rule id="yesno">
            		<one-of>
            			<item>
            				<item> yes </item>
            				<item repeat="0-1"> please </item>
            				<tag> out.Text = "yes" </tag>
            			</item>
            			<item>
            				<item> no </item>
            				<item repeat="0-1"> thank you </item>
            				<tag> out.Text = "no" </tag>
            			</item>
            		</one-of>
            	</rule>
            </grammar>
        </field>

        <filled namelist="Text">
        	<if cond="Text=='yes'">
        		<goto next="#TextedResults" />
        	<elseif cond="Text='no'" />
        		<goto next="hello.xml#Exit" />
        	</if>
        </filled>
    </form>

    <form id="TextedResults">
        <block>
        	<data srcexpr="assembleTextUrl(application.requestedData)" namelist="application.requestedData session.callerid" />
            <prompt>
                Text message sent. Have a great day!
                <break />
            </prompt>
        </block>
    </form>

</vxml>
