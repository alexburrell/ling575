<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE vxml PUBLIC "-//W3C//DTD VOICEXML 2.1//EN" "http://www.w3.org/TR/2007/REC-voicexml21-20070619/vxml.dtd">

<vxml version="2.1" xmlns="http://www.w3.org/2001/vxml" xmlns:voxeo="http://community.voxeo.com/xmlns/vxml" application="root.xml">
    <meta name="maintainer" content="burrelal@gmail.com" />

    <script><![CDATA[
        var searchUrl = "https://maps.googleapis.com/maps/api/place/textsearch/xml?query={query}&key=AIzaSyCVqHbaIe-Dtnt7WUHGOHUAUuV1_OWFoag",
            placeUrl = "https://maps.googleapis.com/maps/api/place/details/xml?placeid={id}&key=AIzaSyCVqHbaIe-Dtnt7WUHGOHUAUuV1_OWFoag",
            textUrl = "text.php";

        function assembleSearchUrl(location, business) {
            location = location.replace(" ", "+");
            business = business.replace(" ", "+");
            return searchUrl.replace("{query}", location+"+"+business);
        }

        function assemblePlaceUrl(place_id) {
            return placeUrl.replace("{id}", place_id);
        }

        function assembleTextUrl(details) {
            details = details.replace(' ', '%20');
            return textUrl.replace("{message}", details);
        }

        function getPlaceId(results) {
            var establishment = results.getElementsByTagName("result").item(0),
                id = establishment.getElementsByTagName("place_id").item(0).firstChild.data;

            return id;
        }

        function assembleIdUrl (place_id) {
        	return idUrl.replace("{query}", place_id);
        }

        function getPlaceId (document) {
        	return document.getElementsByTagName("place_id").item(0).textContent;
        }

        function getLocalDay(offset) {
            var today = new Date(),
                utc = today.getTime() + (today.getTimezoneOffset() * 60000),
                local_date = new Date(utc + (3600000 * offset)),
                local_day = local_date.getDay() - 1;

            if (local_day < 0) local_day = 6;

            return local_day;
        }

        function parseResults(results, timezone) {
            var today = getLocalDay(timezone);

            var establishment = results.getElementsByTagName("result").item(0),
                address = establishment.getElementsByTagName("formatted_address").item(0).firstChild.data,
                phone = establishment.getElementsByTagName("formatted_phone_number").item(0).firstChild.data,
                hours = establishment.getElementsByTagName("weekday_text").item(today).firstChild.data;

            address = address.replace(', United States', '')

            return results = {
                'address': address,
                'phone': phone,
                'hours': hours
            }
        }

        function get(obj, key) {
            return obj[key];
        }
    ]]></script>

    <form id="GetDetails">
        <block>
            <!-- Search using the location and business params, and get the ID -->
            <data name="SearchResults" srcexpr="assembleSearchUrl(application.location, application.business)" />
            <assign name="SearchResults" expr="SearchResults.documentElement" />
            <assign name="application.placeid" expr="getPlaceId(SearchResults)" />

            <!-- Get the place details -->
            <data name="PlaceDetails" srcexpr="assemblePlaceUrl(application.placeid)" />
            <assign name="PlaceDetails" expr="PlaceDetails.documentElement" />
            <assign name="application.result" expr="parseResults(PlaceDetails, application.timezone)" />

			<goto next="#ProvideResults" />
        </block>
    </form>

    <form id="ProvideResults">
    	<block>
            <assign name="application.requestedData" expr="get(application.result, application.request_type)" />
    		<prompt>
                Here's the <value expr="application.request_type"/> for <value expr="application.business"/>
    	    	in <value expr="application.location"/>
        		<value expr="application.requestedData" />
        	</prompt>
            <goto next="#TextResults" />
    	</block>
    </form>

    <form id="TextResults">
        <block>
            <prompt>
                Text 1
            </prompt>
            <submit expr="assembleTextUrl(get(application.result, application.request_type))" namelist="application.requestedData session.callerid" />
            <goto next="#TextedResults" />
        </block>
    </form>

    <form id="TextedResults">
        <block>
            <prompt>
                Texted
            </prompt>
        </block>
    </form>

</vxml>
